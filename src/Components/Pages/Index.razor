@page "/"
@using System.Reflection
@using AzureNamingTool.Helpers
@using AzureNamingTool.Models
@using AzureNamingTool.Services
@using AzureNamingTool.Services.Interfaces
@using Markdig;
@inject ILogger<Index> Logger
@inject NavigationManager NavigationManager
@inject StateContainer state
@inject ProtectedSessionStorage session

<PageTitle>@toolname - Home</PageTitle>

<div class="modern-page-header">
    <div class="modern-page-title">
        <h1>Dashboard</h1>
        <p class="modern-page-subtitle">Welcome to the Azure Naming Tool</p>
    </div>
</div>

<div class="modern-dashboard-container">
    <!-- Logo Section -->
    <div class="modern-card">
        <div class="modern-card-body text-center">
            <img src="@logopath" height="160" alt="@toolname" />
        </div>
    </div>

    @if (!String.IsNullOrEmpty(customhomecontent))
    {
        <div class="modern-card">
            <div class="modern-card-body">
                @((MarkupString)Markdown.ToHtml(customhomecontent))
            </div>
        </div>
    }
    else
    {
        <!-- Stats Grid -->
        <div class="modern-stats-grid">
            <div class="modern-stat-card">
                <div class="stat-icon">üìã</div>
                <div class="stat-value">@resourceTypeCount</div>
                <div class="stat-label">Resource Types</div>
            </div>
            <div class="modern-stat-card">
                <div class="stat-icon">üåç</div>
                <div class="stat-value">@locationCount</div>
                <div class="stat-label">Locations</div>
            </div>
            <div class="modern-stat-card">
                <div class="stat-icon">üè¢</div>
                <div class="stat-value">@environmentCount</div>
                <div class="stat-label">Environments</div>
            </div>
            <div class="modern-stat-card">
                <div class="stat-icon">‚ú®</div>
                <div class="stat-value">@generatedCount</div>
                <div class="stat-label">Names Generated</div>
            </div>
        </div>

        <!-- Disclaimer Card -->
        <div class="modern-card modern-info-card">
            <div class="modern-card-header">
                <h3>Disclaimer</h3>
            </div>
            <div class="modern-card-body">
                <p>
                    This tool was designed using the best practices in the <a href="https://docs.microsoft.com/en-us/azure/cloud-adoption-framework/" target="_blank" class="modern-link">Azure Cloud Adoption Framework</a> which adheres to a few rules and allows the complete customization of your naming convention. While most of the customizations can be made in your web browser, this tool also includes an API.
                </p>
                <p>
                    For guidance on the API, review your swagger page at: <a href="swagger/index.html" target="_blank" class="modern-link fw-bold">swagger/index.html</a>
                </p>
            </div>
        </div>

        <!-- Quick Start Guide -->
        <div class="modern-card">
            <div class="modern-card-header">
                <h3>Quick Start Guide</h3>
            </div>
            <div class="modern-card-body">
                <div class="modern-feature-list">
                    <div class="modern-feature-item">
                        <div class="feature-icon">üîß</div>
                        <div class="feature-content">
                            <h4>Admin</h4>
                            <p>The Admin page is used to configure the Azure Naming Tool. This page is only accessible by Admin users.</p>
                        </div>
                    </div>

                    @if (Convert.ToBoolean(config.InstructionsEnabled) || admin)
                    {
                        <div class="modern-feature-item">
                            <div class="feature-icon">üìñ</div>
                            <div class="feature-content">
                                <h4>Instructions</h4>
                                <p>The Instructions page provides documentation for the site pages. Each page of the site contains a documentation link (top right) that will open contextual instructions for the current page.</p>
                            </div>
                        </div>
                    }

                    <div class="modern-feature-item">
                        <div class="feature-icon">‚öôÔ∏è</div>
                        <div class="feature-content">
                            <h4>Configuration</h4>
                            <p>The Configuration page provides all the data points that make up your naming convention. There are 8 standard components that may be used to name each Azure resource. The data within each of those components can be completely customized, except for the resource types.</p>
                        </div>
                    </div>

                    <div class="modern-feature-item">
                        <div class="feature-icon">üìö</div>
                        <div class="feature-content">
                            <h4>Reference</h4>
                            <p>The Reference page provides an example of each Azure resource type using your defined naming convention. The example values do not include any excluded naming components.</p>
                        </div>
                    </div>

                    <div class="modern-feature-item">
                        <div class="feature-icon">üéØ</div>
                        <div class="feature-content">
                            <h4>Generate</h4>
                            <p>The Generate page provides a drop-down menu to select an Azure resource type. Once a resource is selected, the naming component options are provided.</p>
                        </div>
                    </div>

                    @if (Convert.ToBoolean(config.GeneratedNamesLogEnabled) || admin)
                    {
                        <div class="modern-feature-item">
                            <div class="feature-icon">üìä</div>
                            <div class="feature-content">
                                <h4>Generated Names Log</h4>
                                <p>The Generated Names Log contains a record of all names generated in the Azure Naming Tool. This includes the date, user, generated name, resource type, and components selected.</p>
                            </div>
                        </div>
                    }
                </div>

                @if (Convert.ToBoolean(config.InstructionsEnabled) || admin)
                {
                    <div class="mt-3">
                        <button class="modern-btn-primary" title="Instructions" @onclick="@(e => OnInstructionsClick())">
                            View Instructions
                        </button>
                    </div>
                }
            </div>
        </div>
    }
</div>
@code {
    [CascadingParameter]
    protected ThemeInfo? theme { get; set; }
    [CascadingParameter]
    public IModalService? Modal { get; set; }
    
    [Inject]
    public IAdminLogService? AdminLogService { get; set; }
    
    [Inject]
    public IResourceTypeService? ResourceTypeService { get; set; }
    
    [Inject]
    public IResourceLocationService? ResourceLocationService { get; set; }
    
    [Inject]
    public IResourceEnvironmentService? ResourceEnvironmentService { get; set; }
    
    [Inject]
    public IGeneratedNamesService? GeneratedNamesService { get; set; }
    
    private bool admin;
    private SiteConfiguration config = ConfigurationHelper.GetConfigurationData();
    private string? customhomecontent = String.Empty;
    private string? logopath = String.Empty;
    private string? toolname = String.Empty;
    
    // Stats for dashboard
    private int resourceTypeCount = 0;
    private int locationCount = 0;
    private int environmentCount = 0;
    private int generatedCount = 0;

    private string appversion = ConfigurationHelper.GetAssemblyVersion();
    private string updateurl = "https://github.com/mspnp/AzureNamingTool/wiki/Updating";

    protected override async Task OnInitializedAsync()
    {
        customhomecontent = ConfigurationHelper.GetAppSetting("CustomHomeContent", false);
        logopath = !String.IsNullOrEmpty(ConfigurationHelper.GetAppSetting("CustomLogoPath", false)) ? ConfigurationHelper.GetAppSetting("CustomLogoPath", false) : "images/AzureNamingToolLogo.png";
        toolname = !String.IsNullOrEmpty(ConfigurationHelper.GetAppSetting("CustomToolName", false)) ? ConfigurationHelper.GetAppSetting("CustomToolName", false) : "Azure Naming Tool";
        
        // Load dashboard stats
        try
        {
            if (ResourceTypeService != null)
            {
                var response = await ResourceTypeService.GetItemsAsync(false);
                if (response.Success && response.ResponseObject != null)
                {
                    var resourceTypes = (List<ResourceType>)response.ResponseObject;
                    resourceTypeCount = resourceTypes.Count;
                }
            }
            
            if (ResourceLocationService != null)
            {
                var response = await ResourceLocationService.GetItemsAsync(false);
                if (response.Success && response.ResponseObject != null)
                {
                    var locations = (List<Models.ResourceLocation>)response.ResponseObject;
                    locationCount = locations.Count;
                }
            }
            
            if (ResourceEnvironmentService != null)
            {
                var response = await ResourceEnvironmentService.GetItemsAsync(false);
                if (response.Success && response.ResponseObject != null)
                {
                    var environments = (List<ResourceEnvironment>)response.ResponseObject;
                    environmentCount = environments.Count;
                }
            }
            
            if (GeneratedNamesService != null && (Convert.ToBoolean(config.GeneratedNamesLogEnabled) || admin))
            {
                var response = await GeneratedNamesService.GetItemsAsync(false);
                if (response.Success && response.ResponseObject != null)
                {
                    var generatedNames = (List<GeneratedName>)response.ResponseObject;
                    generatedCount = generatedNames.Count;
                }
            }
        }
        catch (Exception ex)
        {
            // Log error but don't fail the page
            if (AdminLogService != null)
            {
                await AdminLogService.PostItemAsync(new AdminLogMessage() { Title = "ERROR", Message = "Error loading dashboard stats: " + ex.Message });
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        var resultAdmin = await session.GetAsync<bool>("admin");
        if (admin != (bool)resultAdmin.Value)
        {
            admin = (bool)resultAdmin.Value;
            StateHasChanged();
        }
        // Determine if the version notification has been dismissed
        var resultNotification = await session.GetAsync<bool>("versionnotification");
        bool notificationshown = resultNotification.Success ? resultNotification.Value : false;

        if (firstRender)
        {
            try
            {
                if (admin)
                {
                    if (await ConfigurationHelper.VerifyConnectivity())
                    {
                        var latestversion = await ConfigurationHelper.GetToolVersion();
                        if (!notificationshown)
                        {
                            // Check if the client's version matches the current offical version
                            if (appversion != latestversion)
                            {
                                ModalHelper.ShowInformationModal(Modal!, theme!, "bg-navcolor", "ATTENTION", "<p style='font-weight:bold;'>Your current version is out of date!</p><p>Please click <a href='" + updateurl + "' target='_blank'>here</a> to update to the current version for the latest features!</p><p><span style='font-weight:bold;'>Installed Version:</span> <span style='font-style:italic; '>" + appversion + "</p><p><span style='font-weight:bold;'>Latest version:</span> <span style='font-style:italic; '>" + latestversion + "</span></p>", "", true);
                                await session.SetAsync("versionnotification", true);
                                StateHasChanged();
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                await AdminLogService.PostItemAsync(new AdminLogMessage() { Title = "ERROR", Message = ex.Message });
            }
        }
    }

    private void OnInstructionsClick()
    {
        NavigationManager.NavigateTo("instructions");
    }
}