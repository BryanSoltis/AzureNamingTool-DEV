@page "/admin"
@using AzureNamingTool.Components.Modals
@using AzureNamingTool.Helpers;
@using AzureNamingTool.Models;
@using System.Runtime.Caching;
@using AzureNamingTool.Services
@using AzureNamingTool.Services.Interfaces;
@using Blazored.Toast.Configuration;
@using BlazorDownloadFile
@using Microsoft.AspNetCore.Html
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.Extensions.Logging
@using System.Reflection;
@using Markdig;
@inject IJSRuntime JsRuntime
@inject StateContainer state
@inject ProtectedSessionStorage session
@inject IToastService toastService
@inject NavigationManager NavigationManager
@inject IHostApplicationLifetime AppLifetime
@inject ProtectedLocalStorage storage
@inject ServicesHelper ServicesHelper
@inject IStorageMigrationService MigrationService

<PageTitle>Azure Naming Tool - Admin</PageTitle>

<div class="modern-page-header">
    <div class="modern-page-title">
        <h1>Admin</h1>
        <p class="modern-page-subtitle">Manage security, configuration, and customization settings</p>
    </div>
    @if (admin)
    {
        <div class="modern-page-actions">
            <button class="modern-btn-secondary" title="Version Information" @onclick="ShowVersionModal">
                <span class="oi oi-info" aria-hidden="true"></span> Version Info
            </button>
            <button class="modern-btn-secondary" title="Instructions" @onclick="@(e => ModalHelper.ShowInformationModal(Modal!, theme, "bg-navcolor", "Admin", String.Empty, "adminconfigurationinstructions", admin))">
                <span class="oi oi-document" aria-hidden="true"></span> Documentation
            </button>
        </div>
    }
</div>

<div class="modern-admin-container">
    @if (!admin)
    {
        <!-- Login Card -->
        <div class="modern-card modern-login-card">
            <div class="modern-card-body">
                <div class="login-icon">üîê</div>
                <h3 class="text-center mb-3">Admin Access Required</h3>
                <p class="text-center text-secondary mb-4">
                    Enter the Global Admin Password to configure the Azure Naming Tool site.
                </p>
                <div class="form-group">
                    <label for="password" class="modern-form-label">Global Admin Password</label>
                    <input title="Password" class="modern-form-input" type="password" @onchange="@((ui) => { SetFormValue("login",(string)ui.Value!);})" />
                </div>
                <div class="text-center mt-3">
                    <button type="submit" class="modern-btn-primary" @onclick="@(e => AdminFormAction("login"))" title="Login">Login</button>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Admin Welcome Message -->
        <div class="modern-info-box">
            <p class="mb-0">
                Welcome to the Admin panel. Manage security settings, site configurations, customizations, and system details for the Azure Naming Tool.
            </p>
        </div>

        <!-- Modern Tab Navigation -->
        <div class="modern-tabs-container">
            <div class="modern-tabs">
                @if (((currentuser == "GlobalAdmin") || (showadmindetailstoallusers)) && (GeneralHelper.IsNotNull(environmentvariables)))
                {
                    <button class="modern-tab active" data-tab="tab-system">
                        <span class="oi oi-wrench tab-icon" aria-hidden="true"></span>
                        System
                    </button>
                }
                <button class="modern-tab @(((currentuser != "GlobalAdmin") && (!showadmindetailstoallusers)) ? "active" : "")" data-tab="tab-customization">
                    <span class="oi oi-brush tab-icon" aria-hidden="true"></span>
                    Customization
                </button>
                <button class="modern-tab" data-tab="tab-settings">
                    <span class="oi oi-cog tab-icon" aria-hidden="true"></span>
                    Site Settings
                </button>
                <button class="modern-tab" data-tab="tab-security">
                    <span class="oi oi-lock-locked tab-icon" aria-hidden="true"></span>
                    Security
                </button>
                <button class="modern-tab" data-tab="tab-identity">
                    <span class="oi oi-people tab-icon" aria-hidden="true"></span>
                    Identity Provider
                </button>
            </div>

            <!-- System Details Tab Content -->
            @if (((currentuser == "GlobalAdmin") || (showadmindetailstoallusers)) && (GeneralHelper.IsNotNull(environmentvariables)))
            {
                <div id="tab-system" class="modern-tab-content active">
                    <h3 class="mb-3">System Details</h3>
                    <p class="text-secondary mb-4">
                        View system information, manage cache, and inspect environment variables for the Azure Naming Tool.
                    </p>
                    <!-- View Cache -->
                    <div class="modern-setting-row">
                        <div class="setting-label">View Cache Data</div>
                        <div class="setting-description">
                            View all currently cached data in the application.
                        </div>
                        <div class="setting-actions">
                            <button type="button" class="modern-btn-secondary" @onclick="@(e => AdminFormAction("viewcachedata"))" title="View Cache Data">
                                <span class="oi oi-eye" aria-hidden="true"></span> View Cache
                            </button>
                        </div>
                    </div>

                    <!-- Clear Cache -->
                    <div class="modern-setting-row">
                        <div class="setting-label">Clear Cache</div>
                        <div class="setting-description">
                            Clear all cached data to force a refresh of configuration and resource data.
                        </div>
                        <div class="setting-actions">
                            <button type="button" class="modern-btn-success" @onclick="@(e => AdminFormAction("clearcache"))" title="Clear Cache">
                                <span class="oi oi-trash" aria-hidden="true"></span> Clear Cache
                            </button>
                        </div>
                    </div>

                    <!-- Environment Details -->
                    <div class="modern-setting-row">
                        <div class="setting-label">Environment Variables</div>
                        <div class="setting-description">
                            View system environment variables and configuration details.
                        </div>
                        <div class="mt-3">
                            <ul class="list-unstyled">
                                @foreach (var variable in environmentvariables)
                                {
                                    <li class="mb-2">
                                        <span class="modern-font-semibold">@variable.Key:</span>
                                        <span class="modern-text-secondary">@variable.Value</span>
                                    </li>
                                }
                            </ul>
                        </div>
                    </div>
                </div>
            }

            <!-- Customization Tab Content -->
            <div id="tab-customization" class="modern-tab-content @(((currentuser != "GlobalAdmin") && (!showadmindetailstoallusers)) ? "active" : "")">
                <h3 class="mb-3">Customization</h3>
                <p class="text-secondary mb-4">
                    Customize the Azure Naming Tool site including home content, logo, and navigation links displayed for non-admin users.
                </p>

                <!-- Custom Home Content -->
                <div class="modern-setting-row">
                    <div class="setting-label">Custom Home Content</div>
                    <div class="setting-description">
                        Enter custom <strong>Markdown</strong> content to display on the Home page. This can provide additional information to users.
                    </div>
                    <div class="mt-3">
                        <MarkdownEditor @bind-Value="@customhomecontent" @ref="mdCustomHomeContent" />
                    </div>
                    <div class="setting-actions">
                        <button type="button" class="modern-btn-success" @onclick="@(e => AdminFormAction("customhomecontentsave"))" title="Save Custom Home Content">
                            <span class="oi oi-check" aria-hidden="true"></span> Save
                        </button>
                        <button type="button" class="modern-btn-secondary" @onclick="@(e => AdminFormAction("customhomecontentclear"))" title="Clear Custom Home Content">
                            <span class="oi oi-x" aria-hidden="true"></span> Clear
                        </button>
                    </div>
                </div>

                <!-- Custom Logo -->
                <div class="modern-setting-row">
                    <div class="setting-label">Custom Logo</div>
                    <div class="setting-description">
                        Upload a custom logo for the site. The logo will be displayed in the navigation and home page.
                    </div>
                    @if (!String.IsNullOrEmpty(customlogopath))
                    {
                        <div class="my-3">
                            <img src="@customlogopath" height="100" alt="Custom Logo" class="modern-border modern-rounded p-2" />
                        </div>
                        <div class="setting-actions">
                            <button type="button" class="modern-btn-danger" @onclick="@(e => AdminFormAction("customlogopathclear"))" title="Delete Custom Logo">
                                <span class="oi oi-trash" aria-hidden="true"></span> Delete Logo
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="my-3">
                            <span class="modern-text-secondary fst-italic">No custom logo uploaded.</span>
                        </div>
                    }
                    <div class="mt-3">
                        <label class="modern-form-label">Upload New Logo</label>
                        <InputFile OnChange="UploadLogo" class="modern-form-input" />
                    </div>
                    <div class="modern-info-box mt-3">
                        <strong>Notes:</strong>
                        <ul class="mb-0 mt-2">
                            <li>You may need to refresh the browser for the custom logo to be displayed.</li>
                            <li>If hosting in a container, uploaded logo images will <strong>NOT</strong> be stored in the <strong>/settings</strong> folder and will not be persisted. If the container is recreated, you will need to re-upload the logo file.</li>
                        </ul>
                    </div>
                </div>

                <!-- Site Navigation -->
                <div class="modern-setting-row">
                    <div class="setting-label">Site Navigation</div>
                    <div class="setting-description">
                        Configure which navigation links are displayed for non-admin users. Documentation links will always remain visible.
                    </div>
                    
                    <div class="mt-3">
                        <div class="modern-flex modern-flex-column modern-gap-3">
                            <!-- Instructions Toggle -->
                            <div class="modern-toggle-row">
                                <div class="toggle-content">
                                    <div class="toggle-label">Instructions Page</div>
                                    <div class="toggle-description">Enable/Disable the Instructions page for non-admin users</div>
                                </div>
                                <div class="toggle-switch-wrapper">
                                    <label class="modern-toggle-switch" title="Instructions Enabled">
                                        <input type="checkbox" checked="@instructionsenabled" @oninput='args => SettingChanged(args, "instructionsenabled")'>
                                        <span class="modern-toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <!-- Configuration Toggle -->
                            <div class="modern-toggle-row">
                                <div class="toggle-content">
                                    <div class="toggle-label">Configuration Page</div>
                                    <div class="toggle-description">Enable/Disable the Configuration page for non-admin users</div>
                                </div>
                                <div class="toggle-switch-wrapper">
                                    <label class="modern-toggle-switch" title="Configuration Enabled">
                                        <input type="checkbox" checked="@configurationenabled" @oninput='args => SettingChanged(args, "configurationenabled")'>
                                        <span class="modern-toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <!-- Reference Toggle -->
                            <div class="modern-toggle-row">
                                <div class="toggle-content">
                                    <div class="toggle-label">Reference Page</div>
                                    <div class="toggle-description">Enable/Disable the Reference page for non-admin users</div>
                                </div>
                                <div class="toggle-switch-wrapper">
                                    <label class="modern-toggle-switch" title="Reference Enabled">
                                        <input type="checkbox" checked="@referenceenabled" @oninput='args => SettingChanged(args, "referenceenabled")'>
                                        <span class="modern-toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <!-- Generated Names Log Toggle -->
                            <div class="modern-toggle-row">
                                <div class="toggle-content">
                                    <div class="toggle-label">Generated Names Log</div>
                                    <div class="toggle-description">Enable/Disable the Generated Names Log page for non-admin users</div>
                                </div>
                                <div class="toggle-switch-wrapper">
                                    <label class="modern-toggle-switch" title="Generated Names Log Enabled">
                                        <input type="checkbox" checked="@generatednameslogenabled" @oninput='args => SettingChanged(args, "generatednameslogenabled")'>
                                        <span class="modern-toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <!-- Latest News Toggle -->
                            <div class="modern-toggle-row">
                                <div class="toggle-content">
                                    <div class="toggle-label">Latest News</div>
                                    <div class="toggle-description">Enable/Disable the Latest News for all users</div>
                                </div>
                                <div class="toggle-switch-wrapper">
                                    <label class="modern-toggle-switch" title="Latest News Enabled">
                                        <input type="checkbox" checked="@latestnewsenabled" @oninput='args => SettingChanged(args, "latestnewsenabled")'>
                                        <span class="modern-toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        <!-- Site Settings Tab Content -->
        <div id="tab-settings" class="modern-tab-content">
            <h3 class="mb-3">Site Settings</h3>
            <p class="text-secondary mb-4">
                Configure general site settings including storage provider, duplicate name handling, resource type editing, and webhooks for the Azure Naming Tool.
            </p>

            <!-- Storage Provider -->
                <div class="modern-setting-row">
                    <div class="setting-label">Storage Provider</div>
                    <div class="setting-description">
                        Configure the storage provider for the Azure Naming Tool. Choose between JSON files or SQLite database for configuration data.
                    </div>
                    
                    <div class="mt-3">
                        <h6><i class="bi bi-info-circle"></i> Current Provider</h6>
                        <div class="@(currentStorageProvider == "SQLite" ? "modern-notification-success" : "modern-notification-info")">
                            <strong>@currentStorageProvider</strong>
                            @if (currentStorageProvider == "SQLite")
                            {
                                <span class="ms-2"><i class="bi bi-check-circle"></i> Using SQLite database</span>
                            }
                            else
                            {
                                <span class="ms-2"><i class="bi bi-file-earmark-text"></i> Using JSON files</span>
                            }
                        </div>
                    </div>

                    @if (currentStorageProvider == "FileSystem")
                    {
                        <div class="mt-3">
                            <h6><i class="bi bi-arrow-up-circle"></i> Upgrade to SQLite</h6>
                            <p>
                                Migrate your configuration data from JSON files to an embedded SQLite database for improved performance and reliability.
                            </p>
                            
                            @if (!preMigrationBackupCompleted)
                            {
                                <div class="modern-notification-warning">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <strong>Step 1: Backup Required</strong><br />
                                    Before migrating to SQLite, you must create a backup of your current configuration. This backup will allow you to restore your data if needed.
                                </div>
                                <button type="button" class="modern-btn-primary" @onclick="@(e => CreatePreMigrationBackup())" title="Create Backup">
                                    <i class="bi bi-download"></i>
                                    <span>Create Backup (Step 1)</span>
                                </button>
                            }
                            else
                            {
                                <div class="modern-notification-success">
                                    <i class="bi bi-check-circle"></i>
                                    <strong>Backup Complete!</strong><br />
                                    Backup file: <code>@preMigrationBackupFileName</code><br />
                                    You can now proceed with the migration.
                                </div>
                                
                                <div class="modern-notification-danger mt-3">
                                    <i class="bi bi-exclamation-triangle-fill"></i>
                                    <strong>IMPORTANT: Migration is one-way only!</strong>
                                    <ul class="mb-0 mt-2">
                                        <li>This migration cannot be automatically reversed</li>
                                        <li>Your JSON files will be preserved for manual restoration if needed</li>
                                        <li>After migration, use the Configuration page to create SQLite backups</li>
                                        <li>The application will restart after migration</li>
                                    </ul>
                                </div>
                                
                                <button type="button" class="modern-btn-warning" @onclick="@(e => InitiateMigration())" disabled="@isMigrating" title="Migrate to SQLite">
                                    @if (isMigrating)
                                    {
                                        <span class="modern-spinner-small me-2" role="status" aria-hidden="true"></span>
                                        <span>Migrating...</span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-database-gear"></i>
                                        <span>Migrate to SQLite (Step 2)</span>
                                    }
                                </button>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="mt-3">
                            <h6><i class="bi bi-check-circle text-success"></i> SQLite Storage Active</h6>
                            <p>
                                Your configuration is stored in an embedded SQLite database.
                            </p>
                            <div class="modern-info-box">
                                <i class="bi bi-info-circle"></i>
                                <strong>Backup & Restore:</strong> Use the <a href="/configuration" class="alert-link">Configuration page</a> to backup and restore your SQLite database or import/export JSON configurations.
                            </div>
                        </div>
                    }

                    @if (!String.IsNullOrEmpty(migrationErrorMessage))
                    {
                        <div class="modern-notification-danger mt-3">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <strong>Error:</strong> @migrationErrorMessage
                        </div>
                    }
                </div>

                <!-- Allow Duplicate Names -->
                <div class="modern-toggle-row">
                    <div class="toggle-content">
                        <div class="toggle-label">Allow Duplicate Names</div>
                        <div class="toggle-description">
                            By default, the Azure Naming Tool prevents duplicate resource names from being generated. Enable this setting to allow duplicate names.
                        </div>
                    </div>
                    <div class="toggle-switch-wrapper">
                        <label class="modern-toggle-switch" title="Duplicate Names Allowed">
                            <input type="checkbox" checked="@duplicatenamesallowed" @oninput='args => SettingChanged(args, "duplicatenamesallowed")'>
                            <span class="modern-toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Auto-Increment Resource Instance -->
                <div class="modern-toggle-row">
                    <div class="toggle-content">
                        <div class="toggle-label">Auto-Increment Resource Instance</div>
                        <div class="toggle-description">
                            If enabled, this setting will increment the <strong>Resource Instance</strong> value to the next number for the generated resource type name.
                        </div>
                    </div>
                    <div class="toggle-switch-wrapper">
                        <label class="modern-toggle-switch" title="Auto-Increment Resource Instance">
                            <input type="checkbox" checked="@autoincrementresourceinstance" @oninput='args => SettingChanged(args, "autoincrementresourceinstance")'>
                            <span class="modern-toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Resource Type Editing -->
                <div class="modern-setting-row">
                    <div class="setting-label">Resource Type Editing</div>
                    <div class="setting-description">
                        By default, <strong>Resource Type Validation</strong> is configured to match the Azure portal. These values can be overridden by enabling the following setting.
                    </div>
                    <div class="modern-warning-box mt-3">
                        <h6>ATTENTION</h6>
                        <p class="mb-0">
                            Please see the <a href="https://github.com/mspnp/AzureNamingTool/wiki/Resource-Type-Editing" target="_blank" class="alert-link">Resource Type Editing documentation</a> for guidance on metadata editing.
                        </p>
                    </div>
                    <div class="modern-toggle-row mt-3">
                        <div class="toggle-content">
                            <div class="toggle-label">Enable Resource Type Editing</div>
                            <div class="toggle-description">Allow editing of resource type validation rules</div>
                        </div>
                        <div class="toggle-switch-wrapper">
                            <label class="modern-toggle-switch" title="Resource Type Editing Enabled">
                                <input type="checkbox" checked="@resourcetypeeditingallowed" @oninput='args => SettingChanged(args, "resourcetypeeditingallowed")'>
                                <span class="modern-toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                @if (currentuser == "GlobalAdmin")
                {
                    <!-- Show Admin Data To All Users (GlobalAdmin only) -->
                    <div class="modern-toggle-row">
                        <div class="toggle-content">
                            <div class="toggle-label">Show Admin Data To All Users</div>
                            <div class="toggle-description">
                                By default, admin details are only displayed for the Global Admin. This setting enables admin details to be shown to all admin users.
                            </div>
                        </div>
                        <div class="toggle-switch-wrapper">
                            <label class="modern-toggle-switch" title="Show Admin Details To All Users">
                                <input type="checkbox" checked="@showadmindetailstoallusers" @oninput='args => SettingChanged(args, "showadmindetailstoallusers")'>
                                <span class="modern-toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                }

                <!-- Connectivity Check -->
                <div class="modern-toggle-row">
                    <div class="toggle-content">
                        <div class="toggle-label">Connectivity Check</div>
                        <div class="toggle-description">
                            The Azure Naming Tool will verify the tool has internet connectivity to enable update features. Use this setting to disable the connectivity check functionality.
                        </div>
                    </div>
                    <div class="toggle-switch-wrapper">
                        <label class="modern-toggle-switch" title="Connectivity Check Enabled">
                            <input type="checkbox" checked="@connectivitycheckenabled" @oninput='args => SettingChanged(args, "connectivitycheckenabled")'>
                            <span class="modern-toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Generation Webhook -->
                <div class="modern-setting-row">
                    <div class="setting-label">Generation Webhook</div>
                    <div class="setting-description">
                        The Azure Naming Tool can post generated names to a webhook. This can be used to integrate with other systems. Enter a valid URL below to save the webhook setting.
                    </div>
                    <div class="mt-3">
                        <p class="text-secondary">
                            Generated names will be posted using the <strong><a href="https://github.com/mspnp/AzureNamingTool/blob/main/src/Models/GeneratedName.cs" target="_blank">GeneratedName</a></strong> JSON format.
                        </p>
                        <button type="button" class="modern-btn-secondary mb-3" @onclick="@(e => AdminFormAction("samplepost"))" title="Sample Post">
                            <span class="oi oi-beaker" aria-hidden="true"></span> Sample Post
                        </button>
                    </div>
                    <div class="mt-3">
                        <label class="modern-form-label">Webhook URL</label>
                        <input title="Generation Webhook" id="currentgenerationwebhook" class="modern-form-input" type="text" @onchange="@((ui) => { SetFormValue("generationwebhook",(string)ui.Value!);})" value="@currentgenerationwebhook" />
                    </div>
                    <div class="setting-actions">
                        <button type="button" class="modern-btn-success" @onclick="@(e => AdminFormAction("generationwebhooksave"))" title="Save Generate Webhook">
                            <span class="oi oi-check" aria-hidden="true"></span> Save
                        </button>
                    </div>
                </div>

                <!-- Reset Site Settings -->
                <div class="modern-setting-row">
                    <div class="setting-label">Reset Site Settings</div>
                    <div class="setting-description">
                        This will reset <strong>ALL</strong> site settings to the default values. This includes site settings and customizations. This cannot be undone!
                    </div>
                    <div class="setting-actions">
                        <button type="button" class="modern-btn-danger" @onclick="@(e => AdminFormAction("resetsitesettings"))" title="Reset Site Settings">
                            <span class="oi oi-warning" aria-hidden="true"></span> Reset Site Settings
                        </button>
                    </div>
                </div>
            </div>

            <!-- Security Tab Content -->
            <div id="tab-security" class="modern-tab-content">
                <h3 class="mb-3">Security</h3>
                <p class="text-secondary mb-4">
                    Manage security settings including the Global Admin password, API keys, identity headers, and admin users for the Azure Naming Tool.
                </p>
                
                @if (currentuser == "GlobalAdmin")
                {
                    <!-- Global Admin Password -->
                    <div class="modern-setting-row">
                        <div class="setting-label">Global Admin Password</div>
                        <div class="setting-description">
                            Enter a new <strong>Global Admin</strong> password for the site.
                        </div>
                        <div class="modern-info-box mt-3">
                            <strong>Password Requirements:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Contain a number</li>
                                <li>Contain one upper case letter</li>
                                <li>Be at least 8 characters</li>
                            </ul>
                        </div>
                        <div class="mt-3">
                            <label class="modern-form-label">New Password</label>
                            <input title="New Password" id="newpassword" class="modern-form-input mb-3" type="password" @onchange="@((ui) => { SetFormValue("password",(string)ui.Value!);})" />
                        </div>
                        <div class="setting-actions">
                            <button title="Save Password" type="button" disabled="@disabled" class="modern-btn-success" @onclick="@(e => AdminFormAction("password"))">
                                <span class="oi oi-check" aria-hidden="true"></span> Save Password
                            </button>
                        </div>
                    </div>

                    <!-- API Keys -->
                    <div class="modern-setting-row">
                        <div class="setting-label">API Keys</div>
                        <div class="setting-description">
                            Manage API keys for accessing the Azure Naming Tool API. Three types of keys are available: Full Access, Name Generation, and Read-Only.
                        </div>

                        <!-- Full Access API Key -->
                        <div class="mt-3 p-3 modern-border modern-rounded">
                            <h6 class="modern-font-semibold">Full Access API Key</h6>
                            <p class="modern-text-secondary">
                                This key provides <strong>full access</strong> to the API. Click <strong>Generate</strong> to create a new random key, or update the text to the desired value.
                            </p>
                            <div class="mb-3">
                                <label class="modern-form-label">API Key</label>
                                <input title="Full Access API Key" id="currentapikey" class="modern-form-input mb-3" type="text" @onchange="@((ui) => { SetFormValue("apikey",(string)ui.Value!);})" value="@currentapikey" />
                            </div>
                            <div class="modern-flex modern-gap-2">
                                <button type="button" class="modern-btn-success" @onclick="@(e => AdminFormAction("apikeysave"))" title="Save Full Access API Key">
                                    <span class="oi oi-check" aria-hidden="true"></span> Save
                                </button>
                                <button type="button" class="modern-btn-secondary" @onclick="@(e => AdminFormAction("apikeygenerate"))" title="Generate Full Access API Key">
                                    <span class="oi oi-reload" aria-hidden="true"></span> Generate
                                </button>
                            </div>
                        </div>

                        <!-- Name Generation API Key -->
                        <div class="mt-3 p-3 modern-border modern-rounded">
                            <h6 class="modern-font-semibold">Name Generation API Key</h6>
                            <p class="modern-text-secondary">
                                This key provides <strong>Name Generation</strong> access to the API (only for name generation). Click <strong>Generate</strong> to create a new random key, or update the text to the desired value.
                            </p>
                            <div class="mb-3">
                                <label class="modern-form-label">API Key</label>
                                <input title="Name Generation API Key" id="currentnamegenerationapikey" class="modern-form-input mb-3" type="text" @onchange="@((ui) => { SetFormValue("namegenerationapikey",(string)ui.Value!);})" value="@currentnamegenerationapikey" />
                            </div>
                            <div class="modern-flex modern-gap-2">
                                <button type="button" class="modern-btn-success" @onclick="@(e => AdminFormAction("namegenerationapikeysave"))" title="Save Name Generation API Key">
                                    <span class="oi oi-check" aria-hidden="true"></span> Save
                                </button>
                                <button type="button" class="modern-btn-secondary" @onclick="@(e => AdminFormAction("namegenerationapikeygenerate"))" title="Generate Name Generation API Key">
                                    <span class="oi oi-reload" aria-hidden="true"></span> Generate
                                </button>
                            </div>
                        </div>

                        <!-- Read-Only API Key -->
                        <div class="mt-3 p-3 modern-border modern-rounded">
                            <h6 class="modern-font-semibold">Read-Only API Key</h6>
                            <p class="modern-text-secondary">
                                This key provides <strong>read-only</strong> access to the API (GET operations only). Click <strong>Generate</strong> to create a new random key, or update the text to the desired value.
                            </p>
                            <div class="mb-3">
                                <label class="modern-form-label">API Key</label>
                                <input title="Read-Only API Key" id="currentreadonlyapikey" class="modern-form-input mb-3" type="text" @onchange="@((ui) => { SetFormValue("readonlyapikey",(string)ui.Value!);})" value="@currentreadonlyapikey" />
                            </div>
                            <div class="modern-flex modern-gap-2">
                                <button type="button" class="modern-btn-success" @onclick="@(e => AdminFormAction("readonlyapikeysave"))" title="Save Read-Only API Key">
                                    <span class="oi oi-check" aria-hidden="true"></span> Save
                                </button>
                                <button type="button" class="modern-btn-secondary" @onclick="@(e => AdminFormAction("readonlyapikeygenerate"))" title="Generate Read-Only API Key">
                                    <span class="oi oi-reload" aria-hidden="true"></span> Generate
                                </button>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="modern-info-box">
                        <span class="fst-italic">Log in with the Global Admin password to update these settings.</span>
                    </div>
                }
            </div>

            <!-- Identity Provider Tab Content -->
            <div id="tab-identity" class="modern-tab-content">
                <h3 class="mb-3">Identity Provider Settings</h3>
                <p class="text-secondary mb-4">
                    Configure the <strong>Identity Provider</strong> settings for the site if authentication is implemented. The Azure Naming Tool is designed to work with <strong><a href="https://learn.microsoft.com/en-us/azure/app-service/overview-authentication-authorization" target="_blank">Azure App Service Authentication</a></strong>, by default.
                </p>
                <p class="text-secondary mb-3">
                    If the Azure Naming Tool is configured to identify users, the site will track user activity. Users can also be designated as Admins using the <strong>Admin Users</strong> configuration. Learn more about Identity Provider Integration <a href="https://soltisweb.com/blog/detail/2023-06-azurenamingtool-identityproviderintegrationdeepdive" target="_blank"><strong>here</strong></a>.
                </p>
                @if (currentuser == "GlobalAdmin")
                {
                    @if (!String.IsNullOrEmpty(currentidentityprovider))
                    {
                        <div class="modern-success-box mb-3">
                            <strong>Azure App Service Authentication Enabled!</strong><br /><br />
                            <strong>Current Identity provider:</strong> @currentidentityprovider.ToUpper()<br /><br />
                            <strong>Default Identity Header Name:</strong> X-MS-CLIENT-PRINCIPAL-NAME
                        </div>
                    }

                    <!-- Identity Header Name -->
                    <div class="modern-setting-row">
                        <div class="setting-label">Identity Header Name</div>
                        <div class="setting-description">
                            This setting is used to identify site users when authenticating using an Identity provider. Authentication using an Identity provider will often inject headers into the request. The site will check for the specified header name and assign the value as the user's identity. This value will be used to log user activity.
                        </div>
                        <div class="mt-3">
                            <label class="modern-form-label">Header Name</label>
                            <input title="Identity Header Name" id="currentidentityheadername" class="modern-form-input mb-3" type="text" @onchange="@((ui) => { SetFormValue("identityheadername",(string)ui.Value!);})" value="@currentidentityheadername" />
                        </div>
                        <div class="setting-actions">
                            <button type="button" class="modern-btn-success" @onclick="@(e => AdminFormAction("identityheadernamesave"))" title="Save Identity Header Name">
                                <span class="oi oi-check" aria-hidden="true"></span> Save
                            </button>
                        </div>
                        <div class="modern-info-box mt-3">
                            <strong>NOTE</strong><br />
                            The Azure Naming Tool is configured for <strong><a href="https://learn.microsoft.com/en-us/azure/app-service/overview-authentication-authorization" target="_blank">Azure App Service Authentication</a></strong> using the <a href="https://learn.microsoft.com/en-us/azure/app-service/configure-authentication-user-identities#access-user-claims-in-app-code" target="_blank"><strong>X-MS-CLIENT-PRINCIPAL-NAME</strong></a> header name. If using a different Identity provider, update the setting to the header name that contains the user's id.
                        </div>
                    </div>

                    <!-- Admin Users -->
                    <!-- Admin Users -->
                    <div class="modern-setting-row">
                        <div class="setting-label">Admin Users</div>
                        <div class="setting-description">
                            When authenticating users with an Identity provider, the <strong>Identity Header Name</strong> setting can be used to identify site users. Enter the user id below to assign the user as an <strong>Admin</strong> for the Azure Naming Tool.
                        </div>

                        @if (!String.IsNullOrEmpty(currentidentityprovider))
                        {
                            @switch (currentidentityprovider.ToLower())
                            {
                                case "aad":
                                    <div class="modern-info-box mt-3">
                                        When using <strong>@currentidentityprovider.ToUpper()</strong> for Azure App Service Authentication, the <strong>X-MS-CLIENT-PRINCIPAL-NAME</strong> header value will be the user's email address.<br /><br /><strong>Example:</strong> example@xyz.com<br /><br />This value should be used to designate the user as an <strong>Admin</strong>.
                                    </div>
                                    break;
                                case "github":
                                    <div class="modern-info-box mt-3">
                                        When using <strong>@currentidentityprovider.ToUpper()</strong> for Azure App Service Authentication, the <strong>X-MS-CLIENT-PRINCIPAL-NAME</strong> header value will be the user's name.<br /><br /><strong>Example:</strong> John Smith<br /><br />This value should be used to designate the user as an <strong>Admin</strong>.
                                    </div>
                                    break;
                                case "google":
                                    <div class="modern-info-box mt-3">
                                        When using <strong>@currentidentityprovider.ToUpper()</strong> for Azure App Service Authentication, the <strong>X-MS-CLIENT-PRINCIPAL-NAME</strong> header value will be the user's email address.<br /><br /><strong>Example:</strong> example@gmail.com<br /><br />This value should be used to designate the user as an <strong>Admin</strong>.
                                    </div>
                                    break;
                            }
                        }

                        <div class="mt-3">
                            <button type="button" class="modern-btn-success" @onclick="@(e => AdminFormAction("adminuseradd"))" title="Add Admin User">
                                <span class="oi oi-plus" aria-hidden="true"></span> Add Admin User
                            </button>
                        </div>

                        @if (GeneralHelper.IsNotNull(servicesData.AdminUsers))
                        {
                            @if (servicesData.AdminUsers.Count > 0)
                            {
                                <div class="table-responsive mt-3">
                                    <table class="modern-table">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in servicesData.AdminUsers)
                                            {
                                                <tr>
                                                    <td>@item.Name</td>
                                                    <td>
                                                        @if (GeneralHelper.NormalizeName(currentuser, true) != GeneralHelper.NormalizeName(@item.Name, true))
                                                        {
                                                            <button type="button" class="modern-btn-danger modern-btn-small" @onclick="@(e => AdminFormAction("adminuserdelete",item.Id))" title="Delete">
                                                                <span class="oi oi-trash" aria-hidden="true"></span>
                                                            </button>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <p class="text-secondary fst-italic mt-3">There are currently no assigned admin users.</p>
                            }
                        }
                        else
                        {
                            <p class="text-secondary fst-italic mt-3">There are currently no assigned admin users.</p>
                        }

                        <div class="modern-warning-box mt-3">
                            <strong>NOTE</strong><br />
                            Added users will need to close their browser and re-open the site for the change to take effect.
                        </div>
                    </div>
                }
                else
                {
                    <div class="modern-info-box">
                        <span class="fst-italic">Log in with the Global Admin password to update these settings.</span>
                    </div>
                }
            </div>
            <!-- End of tab-identity -->
        </div>
        <!-- End of modern-tabs-container -->
    }
    <!-- End of else (admin) block -->
</div>
<!-- End of modern-admin-container -->

@code {
    [CascadingParameter]
    protected ThemeInfo theme { get; set; } = new();
    [CascadingParameter]
    public IModalService? Modal { get; set; }
    [CascadingParameter]
    private IdentityProviderDetails identityProviderDetails { get; set; } = new();
    
    [Inject]
    public IAdminService? AdminService { get; set; }
    
    [Inject]
    protected IJSRuntime? JSRuntime { get; set; }
    
    [Inject]
    public IAdminUserService? AdminUserService { get; set; }
    
    [Inject]
    public IAdminLogService? AdminLogService { get; set; }
    
    [Inject]
    public IImportExportService? ImportExportService { get; set; }
    
    [Inject]
    public IBlazorDownloadFileService? BlazorDownloadFileService { get; set; }
    
    private ServicesData servicesData = new();
    private string currentpassword = String.Empty;
    private string newpassword = String.Empty;
    private string currentapikey = String.Empty;
    private string currentreadonlyapikey = String.Empty;
    private string currentnamegenerationapikey = String.Empty;
    private string currentidentityheadername = String.Empty;
    private string currentidentityprovider = String.Empty;
    private ResponseMessage message = new();
    private bool admin;
    private bool versionalertshown = false;
    private bool disabled = true;
    private bool dismissalert = false;
    private bool duplicatenamesallowed = false;
    private bool connectivitycheckenabled = true;
    private bool resourcetypeeditingallowed = false;
    private bool autoincrementresourceinstance = false;
    private bool instructionsenabled = false;
    private bool generatednameslogenabled = false;
    private bool configurationenabled = false;
    private bool referenceenabled = false;
    private bool latestnewsenabled = false;
    private bool retaingenerateselections = false;
    private bool showadmindetailstoallusers = false;
    private string customhomecontent = String.Empty;
    MarkdownEditor mdCustomHomeContent = new();
    private string customlogopath = String.Empty;
    private string customtoolname = String.Empty;
    private string currentgenerationwebhook = String.Empty;
    private string versionalert = String.Empty;
    private string appversion = String.Empty;
    private SiteConfiguration config = ConfigurationHelper.GetConfigurationData();
    private string currentuser = String.Empty;
    private List<KeyValuePair<string, string>> environmentvariables = new();
    private string releasenotesurl = String.Empty;
    private long maxFileSize = 2000000;
    
    // Storage migration related variables
    private string currentStorageProvider = "FileSystem";
    private bool isMigrating = false;
    private string migrationErrorMessage = String.Empty;
    private bool preMigrationBackupCompleted = false;
    private string preMigrationBackupFileName = String.Empty;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        currentuser = await IdentityHelper.GetCurrentUser(session);
        if (firstRender)
        {
            appversion = ConfigurationHelper.GetAssemblyVersion();
            releasenotesurl = "https://github.com/mspnp/AzureNamingTool/wiki/v" + appversion;

            servicesData = await ServicesHelper.LoadServicesData(servicesData, true);
            var result = await session.GetAsync<bool>("admin");
            admin = (bool)result.Value;
            if (admin)
            {
                currentapikey = GeneralHelper.DecryptString(config.APIKey!, config.SALTKey!);
                currentreadonlyapikey = GeneralHelper.DecryptString(config.ReadOnlyAPIKey!, config.SALTKey!);
                currentnamegenerationapikey = GeneralHelper.DecryptString(config.NameGenerationAPIKey!, config.SALTKey!);
                // Determine if the version notification has been dismissed
                var resultVersionAlert = await session.GetAsync<bool>("versionalert-" + appversion + "-shown");
                versionalertshown = resultVersionAlert.Success ? resultVersionAlert.Value : false;
                versionalert = ConfigurationHelper.GetVersionAlert(true).Result;
                duplicatenamesallowed = Convert.ToBoolean(ConfigurationHelper.GetAppSetting("DuplicateNamesAllowed"));
                connectivitycheckenabled = Convert.ToBoolean(ConfigurationHelper.GetAppSetting("ConnectivityCheckEnabled"));
                resourcetypeeditingallowed = Convert.ToBoolean(ConfigurationHelper.GetAppSetting("ResourceTypeEditingAllowed"));
                autoincrementresourceinstance = Convert.ToBoolean(ConfigurationHelper.GetAppSetting("AutoIncrementResourceInstance"));
                instructionsenabled = Convert.ToBoolean(ConfigurationHelper.GetAppSetting("InstructionsEnabled"));
                generatednameslogenabled = Convert.ToBoolean(ConfigurationHelper.GetAppSetting("GeneratedNamesLogEnabled"));
                configurationenabled = Convert.ToBoolean(ConfigurationHelper.GetAppSetting("ConfigurationEnabled"));
                referenceenabled = Convert.ToBoolean(ConfigurationHelper.GetAppSetting("ReferenceEnabled"));
                latestnewsenabled = Convert.ToBoolean(ConfigurationHelper.GetAppSetting("LatestNewsEnabled"));
                retaingenerateselections = Convert.ToBoolean(ConfigurationHelper.GetAppSetting("RetainGenerateSelections"));
                showadmindetailstoallusers = Convert.ToBoolean(ConfigurationHelper.GetAppSetting("ShowAdminDetailsToAllUsers"));
                customhomecontent = ConfigurationHelper.GetAppSetting("CustomHomeContent", false);
                //await mdCustomHomeContent.SetValueAsync(customhomecontent);
                customlogopath = ConfigurationHelper.GetAppSetting("CustomLogoPath", false);
                customtoolname = ConfigurationHelper.GetAppSetting("CustomToolName", false);
                currentgenerationwebhook = ConfigurationHelper.GetAppSetting("GenerationWebhook", true);
                currentidentityheadername = ConfigurationHelper.GetAppSetting("IdentityHeaderName", true);
                if (GeneralHelper.IsNotNull(identityProviderDetails))
                {
                    if (!String.IsNullOrEmpty(identityProviderDetails.CurrentIdentityProvider))
                    {
                        currentidentityprovider = identityProviderDetails.CurrentIdentityProvider;
                    }
                }
                environmentvariables = ConfigurationHelper.GetEnvironmentVariables();
                
                // Load current storage provider
                currentStorageProvider = ConfigurationHelper.GetAppSetting("StorageProvider");
                if (string.IsNullOrEmpty(currentStorageProvider))
                {
                    currentStorageProvider = "FileSystem";
                }
            }

            await storage.SetAsync("apptheme", theme.ThemeStyle);
            state.AppTheme = theme.ThemeStyle;

            StateHasChanged();
            
            // Initialize tabs after state has changed and DOM is ready
            if (JSRuntime != null)
            {
                await Task.Delay(100); // Small delay to ensure DOM is rendered
                await JSRuntime.InvokeVoidAsync("initializeTabs");
            }

            var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
            if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("reset", out var _reset))
            {
                if (Convert.ToBoolean(_reset))
                {
                    toastService.ShowSuccess("The site settings have been reset!");
                }
            }

        }
    }

    private async Task CreatePreMigrationBackup()
    {
        try
        {
            var response = await ImportExportService!.ExportConfigAsync(true); // Include admin data
            if (!response.Success || response.ResponseObject == null)
            {
                toastService.ShowError("Failed to create backup: " + response.ResponseMessage);
                return;
            }

            string jsonData = System.Text.Json.JsonSerializer.Serialize(response.ResponseObject);
            preMigrationBackupFileName = $"azurenamingtool-pre-migration-{DateTime.Now:yyyyMMdd-HHmmss}.json";
            byte[] fileBytes = System.Text.Encoding.UTF8.GetBytes(jsonData);
            
            await BlazorDownloadFileService!.DownloadFile(preMigrationBackupFileName, fileBytes, "application/json");
            
            preMigrationBackupCompleted = true;
            StateHasChanged();
            
            toastService.ShowSuccess($"Backup created successfully! File: {preMigrationBackupFileName}");
            
            await AdminLogService!.PostItemAsync(new AdminLogMessage() 
            { 
                Title = "INFORMATION", 
                Message = $"Pre-migration backup created: {preMigrationBackupFileName} (Size: {FormatFileSize(fileBytes.Length)})"
            });
        }
        catch (Exception ex)
        {
            toastService.ShowError("Failed to create backup: " + ex.Message);
            
            await AdminLogService!.PostItemAsync(new AdminLogMessage() 
            { 
                Title = "ERROR", 
                Message = "Pre-migration backup failed: " + ex.Message 
            });
        }
    }

    private async Task InitiateMigration()
    {
        // First confirmation
        var confirm1 = await ModalHelper.ShowConfirmationModal(
            Modal!, 
            "ATTENTION - Migration Confirmation (Step 1 of 2)", 
            "<div class=\"my-4\"><p><strong>You are about to migrate to SQLite storage.</strong></p>" +
            "<p class=\"text-danger\"><strong>IMPORTANT: This migration is ONE-WAY and cannot be automatically reversed!</strong></p>" +
            "<ul>" +
            "<li>Your JSON backup has been created and downloaded</li>" +
            "<li>JSON files will be preserved but no longer used</li>" +
            "<li>To restore from backup later, use the Configuration page</li>" +
            "<li>The application will restart after migration</li>" +
            "</ul>" +
            "<p>Do you understand and want to proceed to Step 2?</p></div>", 
            "bg-warning", 
            theme
        );

        if (!confirm1)
        {
            return;
        }

        // Second confirmation with text input required
        var confirm2 = await ModalHelper.ShowTextConfirmationModal(
            Modal!, 
            "FINAL CONFIRMATION (Step 2 of 2)", 
            "<div class=\"my-4\"><p class=\"text-danger\"><strong>FINAL WARNING: This action cannot be undone!</strong></p>" +
            "<p>The migration to SQLite is irreversible. Your JSON files will be preserved but no longer actively used.</p>" +
            "<p>You will need to use the Configuration page to restore from backups if needed.</p></div>",
            "MIGRATE",
            "bg-danger", 
            theme,
            true  // case-sensitive
        );

        if (!confirm2)
        {
            return;
        }

        try
        {
            isMigrating = true;
            migrationErrorMessage = String.Empty;
            StateHasChanged();

            // Execute the migration
            var result = await MigrationService.MigrateToSQLiteAsync();

            if (result.Success)
            {
                // Update configuration to use SQLite
                ConfigurationHelper.SetAppSetting("StorageProvider", "SQLite");
                currentStorageProvider = "SQLite";

                toastService.ShowSuccess("Migration to SQLite completed successfully! The application will restart in 3 seconds...");
                
                await AdminLogService!.PostItemAsync(new AdminLogMessage() 
                { 
                    Title = "SUCCESS", 
                    Message = $"Migrated to SQLite storage successfully. Pre-migration backup: {preMigrationBackupFileName}"
                });

                // Add JavaScript to attempt auto-reload when server comes back
                await JsRuntime.InvokeVoidAsync("eval", @"
                    setTimeout(function() {
                        var checkInterval = setInterval(function() {
                            fetch('/')
                                .then(function(response) {
                                    if (response.ok) {
                                        clearInterval(checkInterval);
                                        window.location.href = '/';
                                    }
                                })
                                .catch(function() {
                                    // Server still down, keep checking
                                });
                        }, 2000);
                    }, 3000);
                ");

                // Trigger application restart
                await Task.Delay(3000);
                AppLifetime.StopApplication();
            }
            else
            {
                migrationErrorMessage = "Migration failed: " + result.Message;
                toastService.ShowError("Migration to SQLite failed. " + result.Message);
                
                await AdminLogService!.PostItemAsync(new AdminLogMessage() 
                { 
                    Title = "ERROR", 
                    Message = "Migration to SQLite failed: " + result.Message 
                });
            }
        }
        catch (Exception ex)
        {
            migrationErrorMessage = "Migration error: " + ex.Message;
            toastService.ShowError("Migration failed: " + ex.Message);
            
            await AdminLogService!.PostItemAsync(new AdminLogMessage() 
            { 
                Title = "ERROR", 
                Message = "Migration to SQLite failed: " + ex.Message 
            });
        }
        finally
        {
            isMigrating = false;
            StateHasChanged();
        }
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private async void AdminFormAction(string action, int id = 0)
    {
        message = new ResponseMessage();
        message.Header = "INFORMATION";
        message.Type = MessageTypesEnum.INFORMATION;
        ServiceResponse serviceResponse = new();
        bool redirect = false;
        bool confirm = false;
        bool displaymessage = true;

        switch (action)
        {
            case "login":
                // Check the password
                if (currentpassword == GeneralHelper.DecryptString(config.AdminPassword!, config.SALTKey!))
                {
                    state.SetAdmin(true);
                    await session.SetAsync("admin", true);
                    await session.SetAsync("currentuser", "GlobalAdmin");
                    // Load the current API Keys
                    currentapikey = GeneralHelper.DecryptString(config.APIKey!, config.SALTKey!);
                    currentreadonlyapikey = GeneralHelper.DecryptString(config.ReadOnlyAPIKey!, config.SALTKey!);
                    message.Type = MessageTypesEnum.INFORMATION;
                    message.Header = "INFORMATION";
                    message.Message = "Global Admin logged in.";
                    admin = true;
                    redirect = true;
                }
                else
                {
                    state.SetAdmin(false);
                    await session.SetAsync("admin", false);
                    message.Type = MessageTypesEnum.ERROR;
                    message.Header = "ERROR";
                    message.Message = "Login failed!";
                }
                break;
            case "logout":
                state.SetAdmin(false);
                await session.SetAsync("admin", false);
                message.Type = MessageTypesEnum.INFORMATION;
                message.Header = "INFORMATION";
                message.Message = "User Logged out.";
                redirect = true;
                break;
            case "password":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div class=\"my-4\">This will update the Global Admin Password.</div><div class=\"my-4\">Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    // Set the new Global admin password
                    serviceResponse = await AdminService!.UpdatePasswordAsync(newpassword);
                    if (serviceResponse.Success)
                    {
                        message.Type = MessageTypesEnum.SUCCESS;
                        message.Header = "SUCCESS";
                        message.Message = "Global Admin Password updated!";
                    }
                    else
                    {
                        message.Type = MessageTypesEnum.ERROR;
                        message.Header = "ERROR";
                        message.Message = "There was a problem updating the Global Admin Password!";
                    }
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "identityheadernamesave":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div class=\"my-4\">This will update the Identity Header Name.</div><div class=\"my-4\">Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    serviceResponse = await AdminService!.UpdateIdentityHeaderNameAsync(currentidentityheadername);
                    if (serviceResponse.Success)
                    {
                        message.Type = MessageTypesEnum.SUCCESS;
                        message.Header = "SUCCESS";
                        message.Message = "Identity Header Name updated!";
                    }
                    else
                    {
                        message.Type = MessageTypesEnum.ERROR;
                        message.Header = "ERROR";
                        message.Message = "There was a problem updating the Identity Header Name!";
                    }
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "apikeysave":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div class=\"my-4\">This will update the Full Access API Key.</div><div class=\"my-4\">Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    serviceResponse = await AdminService!.UpdateAPIKeyAsync(currentapikey, "fullaccess");
                    if (serviceResponse.Success)
                    {
                        message.Type = MessageTypesEnum.SUCCESS;
                        message.Header = "SUCCESS";
                        message.Message = "Full Access API Key updated!";
                    }
                    else
                    {
                        message.Type = MessageTypesEnum.ERROR;
                        message.Header = "ERROR";
                        message.Message = "There was a problem updating the Full Access API Key!";
                    }
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "apikeygenerate":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div class=\"my-4\">This will generate a new Full Access API Key.</div><div class=\"my-4\">Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    serviceResponse = await AdminService!.GenerateAPIKeyAsync("fullaccess");
                    if (serviceResponse.Success)
                    {
                        if (GeneralHelper.IsNotNull(serviceResponse.ResponseObject))
                        {
                            currentapikey = serviceResponse.ResponseObject!;
                            message.Type = MessageTypesEnum.SUCCESS;
                            message.Header = "SUCCESS";
                            message.Message = "Full Access API Key updated!";
                        }
                        else
                        {
                            message.Type = MessageTypesEnum.ERROR;
                            message.Header = "ERROR";
                            message.Message = "There was a problem generating the Full Access API Key!";
                        }
                    }
                    else
                    {
                        message.Type = MessageTypesEnum.ERROR;
                        message.Header = "ERROR";
                        message.Message = "There was a problem generating the Full Access API Key!";
                    }
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "namegenerationapikeysave":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div class=\"my-4\">This will update the Name Generation API Key.</div><div class=\"my-4\">Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    serviceResponse = await AdminService!.UpdateAPIKeyAsync(currentnamegenerationapikey, "namegeneration");
                    if (serviceResponse.Success)
                    {
                        message.Type = MessageTypesEnum.SUCCESS;
                        message.Header = "SUCCESS";
                        message.Message = "Name Generation API Key updated!";
                    }
                    else
                    {
                        message.Type = MessageTypesEnum.ERROR;
                        message.Header = "ERROR";
                        message.Message = "There was a problem updating the Name Generation API Key!";
                    }
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "namegenerationapikeygenerate":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div class=\"my-4\">This will generate a new Name Generation API Key.</div><div class=\"my-4\">Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    serviceResponse = await AdminService!.GenerateAPIKeyAsync("namegeneration");
                    if (serviceResponse.Success)
                    {
                        if (GeneralHelper.IsNotNull(serviceResponse.ResponseObject))
                        {
                            currentnamegenerationapikey = serviceResponse.ResponseObject!;
                            message.Type = MessageTypesEnum.SUCCESS;
                            message.Header = "SUCCESS";
                            message.Message = "Name Generation API Key updated!";
                        }
                        else
                        {
                            message.Type = MessageTypesEnum.ERROR;
                            message.Header = "ERROR";
                            message.Message = "There was a problem generating the Name Generation API Key!";
                        }
                    }
                    else
                    {
                        message.Type = MessageTypesEnum.ERROR;
                        message.Header = "ERROR";
                        message.Message = "There was a problem generating the Name Generation API Key!";
                    }
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "readonlyapikeysave":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div class=\"my-4\">This will update the Read-Only API Key.</div><div class=\"my-4\">Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    serviceResponse = await AdminService!.UpdateAPIKeyAsync(currentreadonlyapikey, "readonly");
                    if (serviceResponse.Success)
                    {
                        message.Type = MessageTypesEnum.SUCCESS;
                        message.Header = "SUCCESS";
                        message.Message = "Read-Only API Key updated!";
                    }
                    else
                    {
                        message.Type = MessageTypesEnum.ERROR;
                        message.Header = "ERROR";
                        message.Message = "There was a problem updating the Read-Only API Key!";
                    }
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "readonlyapikeygenerate":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div class=\"my-4\">This will generate a new Read-Only API Key.</div><div class=\"my-4\">Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    serviceResponse = await AdminService!.GenerateAPIKeyAsync("readonly");
                    if (serviceResponse.Success)
                    {
                        if (GeneralHelper.IsNotNull(serviceResponse.ResponseObject))
                        {
                            currentreadonlyapikey = serviceResponse.ResponseObject!;
                            message.Type = MessageTypesEnum.SUCCESS;
                            message.Header = "SUCCESS";
                            message.Message = "Read-Only API Key updated!";
                        }
                        else
                        {
                            message.Type = MessageTypesEnum.ERROR;
                            message.Header = "ERROR";
                            message.Message = "There was a problem generating the Read-Only API Key!";
                        }
                    }
                    else
                    {
                        message.Type = MessageTypesEnum.ERROR;
                        message.Header = "ERROR";
                        message.Message = "There was a problem generating the Read-Only API Key!";
                    }
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "generationwebhooksave":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div class=\"my-4\">This will update the Generation Webhook.</div><div class=\"my-4\">Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    if (!String.IsNullOrEmpty(currentgenerationwebhook))
                    {
                        if (!Uri.IsWellFormedUriString(currentgenerationwebhook, UriKind.Absolute))
                        {
                            message.Header = "ERROR";
                            message.Type = MessageTypesEnum.ERROR;
                            message.Message = "You must enter a valid URL!";
                            break;
                        }
                    }
                    ConfigurationHelper.SetAppSetting("GenerationWebhook", currentgenerationwebhook, true);
                    message.Type = MessageTypesEnum.SUCCESS;
                    message.Header = "SUCCESS";
                    message.Message = "Generation Webhook configuration saved!";
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "customhomecontentsave":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div class=\"my-4\">This will update the Custom Home content.</div><div class=\"my-4\">Are you sure?</div>", "bg-primary", theme);
                if (confirm)
                {
                    ConfigurationHelper.SetAppSetting("CustomHomeContent", customhomecontent, false);
                    await mdCustomHomeContent.SetValueAsync(customhomecontent);
                    message.Type = MessageTypesEnum.SUCCESS;
                    message.Header = "SUCCESS";
                    message.Message = "Custom Home content saved!";
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "customhomecontentclear":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div class=\"my-4\">This will clear the Custom Home content.</div><div class=\"my-4\">Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    ConfigurationHelper.SetAppSetting("CustomHomeContent", String.Empty, false);
                    customhomecontent = String.Empty;
                    await mdCustomHomeContent.SetValueAsync(customhomecontent);
                    message.Type = MessageTypesEnum.SUCCESS;
                    message.Header = "SUCCESS";
                    message.Message = "Custom Home content cleared!";
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "customlogopathsave":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div class=\"my-4\">This will update the Custom Logo.</div><div class=\"my-4\">Are you sure?</div>", "bg-primary", theme);
                if (confirm)
                {
                    ConfigurationHelper.SetAppSetting("CustomLogoPath", customlogopath, false);
                    message.Type = MessageTypesEnum.SUCCESS;
                    message.Header = "SUCCESS";
                    message.Message = "Custom Logo saved!";
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "customlogopathclear":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div class=\"my-4\">This will clear the Custom Logo.</div><div class=\"my-4\">Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    ConfigurationHelper.SetAppSetting("CustomLogoPath", String.Empty, false);
                    customlogopath = String.Empty;
                    message.Type = MessageTypesEnum.SUCCESS;
                    message.Header = "SUCCESS";
                    message.Message = "Custom Logo cleared!";
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "customtoolnamesave":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div class=\"my-4\">This will update the Custom Tool Name.</div><div class=\"my-4\">Are you sure?</div>", "bg-primary", theme);
                if (confirm)
                {
                    ConfigurationHelper.SetAppSetting("CustomToolName", customtoolname, false);
                    message.Type = MessageTypesEnum.SUCCESS;
                    message.Header = "SUCCESS";
                    message.Message = "Custom Tool Name saved!";
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "customtoolnameclear":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div class=\"my-4\">This will clear the Custom Tool Name.</div><div class=\"my-4\">Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    ConfigurationHelper.SetAppSetting("CustomToolName", String.Empty, false);
                    customtoolname = String.Empty;
                    message.Type = MessageTypesEnum.SUCCESS;
                    message.Header = "SUCCESS";
                    message.Message = "Custom Tool Name cleared!";
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "clearcache":
                CacheHelper.ClearAllCache();
                message.Type = MessageTypesEnum.SUCCESS;
                message.Header = "SUCCESS";
                message.Message = "Cache cleared!";
                break;
            case "viewcachedata":
                string cachedata = CacheHelper.GetAllCacheData();
                ModalHelper.ShowInformationModal(Modal!, theme, "bg-navcolor", "Cache Data", "<p>This is the current cache data.</p>" + cachedata, "", admin);
                displaymessage = false;
                break;
            case "samplepost":
                string webhookdata = await FileSystemHelper.ReadFile("samplewebhookdata.json", "");
                ModalHelper.ShowInformationModal(Modal!, theme, "bg-navcolor", "Sample Post", "<p>This is a sample Generation Webhook post.</p><code style=\"display: block; white-space: pre-wrap;\">" + webhookdata + "</code>", "", admin);
                displaymessage = false;
                break;
            case "adminuseradd":
                bool added = await ModalHelper.ShowAddModal(Modal!, servicesData, theme, "bg-navcolor", "Add Admin User", "<p>Add an Admin User.</p>", id, "AdminUser", admin, "");
                if (added)
                {
                    servicesData = await ServicesHelper.LoadServicesData(servicesData, admin);
                    state.SetNavReload(true);
                    StateHasChanged();
                }
                else
                {
                    displaymessage = false;
                }
                break;
            case "adminuserdelete":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div class=\"my-4\">This will delete the Admin User.</div><div class=\"my-4\">Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    serviceResponse = await AdminUserService!.DeleteItemAsync(Convert.ToInt32(id));
                    if (serviceResponse.Success)
                    {
                        message.Type = MessageTypesEnum.SUCCESS;
                        message.Message = "Admin User deleted!";
                    }
                    else
                    {
                        message.Type = MessageTypesEnum.ERROR;
                        message.Message = "Admin User deletion failed!";
                        message.MessageDetails = serviceResponse.ResponseMessage;
                    }
                }
                else
                {
                    displaymessage = false;
                }
                break;

            case "resetsitesettings":
                confirm = await ModalHelper.ShowConfirmationModal(Modal!, "ATTENTION", "<div class=\"my-4\">This will reset <span class=\"fw-bold\">ALL</span> site settings. This includes site settings and cusomtizations.</div><div class=\"my-4\">Are you sure?</div>", "bg-danger", theme);
                if (confirm)
                {
                    // Create new default configuration
                    SiteConfiguration resetconfig = new();
                    ConfigurationHelper.SetAppSetting("AutoIncrementResourceInstance", resetconfig.AutoIncrementResourceInstance!, false);
                    ConfigurationHelper.SetAppSetting("DuplicateNamesAllowed", resetconfig.DuplicateNamesAllowed!, false);
                    ConfigurationHelper.SetAppSetting("ResourceTypeEditingAllowed", resetconfig.ResourceTypeEditingAllowed!, false);
                    ConfigurationHelper.SetAppSetting("InstructionsEnabled", resetconfig.InstructionsEnabled!, false);
                    ConfigurationHelper.SetAppSetting("GeneratedNamesLogEnabled", resetconfig.GeneratedNamesLogEnabled!, false);
                    ConfigurationHelper.SetAppSetting("ConfigurationEnabled", resetconfig.ConfigurationEnabled!, false);
                    ConfigurationHelper.SetAppSetting("ReferenceEnabled", resetconfig.ReferenceEnabled!, false);
                    ConfigurationHelper.SetAppSetting("LatestNewsEnabled", resetconfig.LatestNewsEnabled!, false);
                    ConfigurationHelper.SetAppSetting("RetainGenerateSelections", resetconfig.RetainGenerateSelections!, false);
                    ConfigurationHelper.SetAppSetting("CustomHomeContent", String.Empty, false);
                    ConfigurationHelper.SetAppSetting("CustomLogoPath", String.Empty, false);
                    ConfigurationHelper.SetAppSetting("CustomToolName", String.Empty, false);
                    ConfigurationHelper.SetAppSetting("ConnectivityCheckEnabled", resetconfig.ConnectivityCheckEnabled!, false);
                    ConfigurationHelper.SetAppSetting("GenerationWebhook", String.Empty, true);
                    ConfigurationHelper.SetAppSetting("ShowAdminDataToAllUsers", String.Empty, true);
                    await AdminLogService!.PostItemAsync(new AdminLogMessage() { Title = MessageTypesEnum.SUCCESS.ToString(), Message = "Site Settings reset!", Source = currentuser });
                    NavigationManager.NavigateTo("admin?reset=true", true);
                }
                else
                {
                    displaymessage = false;
                }
                break;
        }

        config = ConfigurationHelper.GetConfigurationData();

        if ((GeneralHelper.IsNotNull(message.Message)) && (displaymessage))
        {
            if (!String.IsNullOrEmpty(message.Message))
            {
                switch (message.Type)
                {
                    case MessageTypesEnum.INFORMATION:
                        toastService.ShowInfo(message.Message);
                        break;
                    case MessageTypesEnum.SUCCESS:
                        toastService.ShowSuccess(message.Message);
                        break;
                    case MessageTypesEnum.WARNING:
                        toastService.ShowWarning(message.Message);
                        break;
                    case MessageTypesEnum.ERROR:
                        toastService.ShowError(message.Message);
                        break;
                }
                await AdminLogService!.PostItemAsync(new AdminLogMessage() { Title = message.Type.ToString(), Message = message.Message, Source = currentuser });
            }
        }

        servicesData = await ServicesHelper.LoadServicesData(servicesData, admin);
        state.SetNavReload(true);
        StateHasChanged();

        if (redirect)
        {
            if (admin)
            {
                NavigationManager.NavigateTo(NavigationManager.Uri, true);
            }
            else
            {
                NavigationManager.NavigateTo("", true);
            }
        }

    }

    private void SetFormValue(string type, string value)
    {
        switch (type)
        {
            case "login":
                currentpassword = value;
                break;
            case "password":
                newpassword = value;
                // Validate the password complexity
                if (ValidationHelper.ValidatePassword(newpassword))
                {
                    disabled = false;
                }
                else
                {
                    disabled = true;
                }
                break;
            case "identityheadername":
                currentidentityheadername = value;
                break;
            case "apikey":
                currentapikey = value;
                break;
            case "namegenerationapikey":
                currentnamegenerationapikey = value;
                break;
            case "readonlyapikey":
                currentreadonlyapikey = value;
                break;
            case "generationwebhook":
                currentgenerationwebhook = value;
                break;
            case "customtoolname":
                customtoolname = value;
                break;
        }
    }

    private async void SettingChanged(ChangeEventArgs e, string setting)
    {
        message = new ResponseMessage();
        message.Header = "INFORMATION";
        message.Type = MessageTypesEnum.INFORMATION;
        try
        {
            if (GeneralHelper.IsNotNull(e.Value))
            {
                switch (setting)
                {
                    case "duplicatenamesallowed":
                        ConfigurationHelper.SetAppSetting("DuplicateNamesAllowed", e.Value.ToString()!);
                        message.Message = "Duplicate Names Allowed setting updated to " + e.Value.ToString()!.ToUpper() + "!";
                        break;
                    case "connectivitycheckenabled":
                        ConfigurationHelper.SetAppSetting("ConnectivityCheckEnabled", e.Value.ToString()!);
                        message.Message = "Connectivity Check Enabled setting updated to " + e.Value.ToString()!.ToUpper() + "!";
                        // Update the tool connection setting to true, if the connecvity check is disabled. This will cause the stie to always assume there is connectivity and attempt external connections.
                        if (!(bool)e.Value)
                        {
                            CacheHelper.SetCacheObject("isconnected", true);
                        }
                        else
                        {
                            CacheHelper.InvalidateCacheObject("isconnected");
                        }
                        if (!(bool)e.Value)
                        {
                            ModalHelper.ShowInformationModal(Modal!, theme, "bg-danger", "ATTENTION", "<p>Disabling this setting may result in connectivity errors being logged to the Admin Log.<p>", "", admin);
                        }

                        break;
                    case "resourcetypeeditingallowed":
                        if (GeneralHelper.IsNotNull(e.Value))
                        {
                            ConfigurationHelper.SetAppSetting("ResourceTypeEditingAllowed", e.Value!.ToString() ?? "");
                            message.Message = "Resource Type Editing Allowed setting updated to " + e.Value?.ToString()!.ToUpper() ?? "" + "!";
                            if ((bool)e.Value!)
                            {
                                ModalHelper.ShowInformationModal(Modal!, theme, "bg-danger", "ATTENTION", "<p>Disabling this setting may result in name generation that will fail regex validation for the resource type.</p><p>Please use caution when editing Resource Type validation settings.", "", admin);
                            }
                        }
                        break;
                    case "autoincrementresourceinstance":
                        if (GeneralHelper.IsNotNull(e.Value))
                        {
                            ConfigurationHelper.SetAppSetting("AutoIncrementResourceInstance", e.Value!.ToString() ?? "");
                            message.Message = "Auto Increment Resource Instance setting updated to " + e.Value?.ToString()!.ToUpper() ?? "" + "!";
                        }
                        break;
                    case "instructionsenabled":
                        if (GeneralHelper.IsNotNull(e.Value))
                        {
                            ConfigurationHelper.SetAppSetting("InstructionsEnabled", e.Value!.ToString() ?? "");
                            message.Message = "Instructions Enabled setting updated to " + e.Value?.ToString()!.ToUpper() ?? "" + "!";
                        }
                        break;
                    case "generatednameslogenabled":
                        if (GeneralHelper.IsNotNull(e.Value))
                        {
                            ConfigurationHelper.SetAppSetting("GeneratedNamesLogEnabled", e.Value!.ToString() ?? "");
                            message.Message = "Generated Names Log Enabled setting updated to " + e.Value?.ToString()!.ToUpper() ?? "" + "!";
                        }
                        break;
                    case "configurationenabled":
                        if (GeneralHelper.IsNotNull(e.Value))
                        {
                            ConfigurationHelper.SetAppSetting("ConfigurationEnabled", e.Value!.ToString() ?? "");
                            message.Message = "Configuration Enabled setting updated to " + e.Value?.ToString()!.ToUpper() ?? "" + "!";
                        }
                        break;
                    case "referenceenabled":
                        if (GeneralHelper.IsNotNull(e.Value))
                        {
                            ConfigurationHelper.SetAppSetting("ReferenceEnabled", e.Value!.ToString() ?? "");
                            message.Message = "Reference Enabled setting updated to " + e.Value?.ToString()!.ToUpper() ?? "" + "!";
                        }
                        break;
                    case "latestnewsenabled":
                        if (GeneralHelper.IsNotNull(e.Value))
                        {
                            ConfigurationHelper.SetAppSetting("LatestNewsEnabled", e.Value!.ToString() ?? "");
                            message.Message = "Latest News Enabled setting updated to " + e.Value?.ToString()!.ToUpper() ?? "" + "!";
                        }
                        break;
                    case "retaingenerateselections":
                        if (GeneralHelper.IsNotNull(e.Value))
                        {
                            ConfigurationHelper.SetAppSetting("RetainGenerateSelections", e.Value!.ToString() ?? "");
                            message.Message = "Retain Generate Selections setting updated to " + e.Value?.ToString()!.ToUpper() ?? "" + "!";
                        }
                        break;
                    case "showadmindetailstoallusers":
                        if (GeneralHelper.IsNotNull(e.Value))
                        {
                            ConfigurationHelper.SetAppSetting("ShowAdminDetailsToAllUsers", e.Value!.ToString() ?? "");
                            message.Message = "Show Admin Details To All Users setting updated to " + e.Value?.ToString()!.ToUpper() ?? "" + "!";
                        }
                        break;
                }
                message.Type = MessageTypesEnum.SUCCESS;
                message.Header = "SUCCESS";
            }
            else
            {
                message.Message = "There was a problem updating the setting!";
                message.Header = "ERROR";
            }
        }
        catch (Exception ex)
        {
            await AdminLogService!.PostItemAsync(new AdminLogMessage() { Title = "ERROR", Message = ex.Message });
            message.Message = "There was a problem updating the setting!";
            message.Header = "ERROR";
        }

        if (GeneralHelper.IsNotNull(message.Message))
        {
            switch (message.Type)
            {
                case MessageTypesEnum.INFORMATION:
                    toastService.ShowInfo(message.Message);
                    break;
                case MessageTypesEnum.SUCCESS:
                    toastService.ShowSuccess(message.Message);
                    break;
                case MessageTypesEnum.WARNING:
                    toastService.ShowWarning(message.Message);
                    break;
                case MessageTypesEnum.ERROR:
                    toastService.ShowError(message.Message);
                    break;
            }
            await AdminLogService!.PostItemAsync(new AdminLogMessage() { Title = message.Type.ToString(), Message = message.Message, Source = currentuser });
        }

        servicesData = await ServicesHelper.LoadServicesData(servicesData, admin);
        state.SetNavReload(true);
        StateHasChanged();
    }

    private async Task OnConfigurationAlertDismissed()
    {
        await session.SetAsync("versionalert-" + appversion + "-shown", true);
        if (dismissalert)
        {
            ConfigurationHelper.DismissVersionAlert();
        }
    }

    private async void ShowVersionModal()
    {
        var parameters = new ModalParameters();
        parameters.Add("VersionNumber", appversion);
        parameters.Add("ReleaseNotesUrl", releasenotesurl);
        parameters.Add("VersionAlert", versionalert);
        
        var options = new ModalOptions()
        {
            HideHeader = false,
            HideCloseButton = false,
            Size = ModalSize.Large
        };
        
        Modal!.Show<VersionInfoModal>("Version Information", parameters, options);
    }

    private async void SubmitGHTopic(string type)
    {
        string githubURL = "";
        switch (type)
        {
            case "bug":
                githubURL = "https://github.com/mspnp/AzureNamingTool/issues/new?assignees=&labels=&projects=&template=bug_report.md&title=";
                break;
            case "feature":
                githubURL = "https://github.com/mspnp/AzureNamingTool/issues/new?assignees=&labels=&projects=&template=feature_request.md&title=";
                break;
            case "discussion":
                githubURL = "https://github.com/mspnp/AzureNamingTool/discussions/new/choose";
                break;
        }
        if (!String.IsNullOrEmpty(githubURL))
        {
            await JsRuntime.InvokeVoidAsync("open", githubURL, "_blank");
        }
    }

    private async void UploadLogo(InputFileChangeEventArgs e)
    {
        message = new ResponseMessage();
        message.Header = "INFORMATION";
        message.Type = MessageTypesEnum.INFORMATION;
        var workingmodaloptions = new ModalOptions()
            {
                HideCloseButton = true,
                UseCustomLayout = true
            };
        var workingmodal = Modal!.Show<WorkingModal>("Working", workingmodaloptions);
        try
        {

            var trustedFileName = Path.GetRandomFileName();
            await using FileStream fs = new(Path.Combine(Environment.CurrentDirectory, "wwwroot/images/" + e.File.Name), FileMode.Create);
            await e.File.OpenReadStream(maxFileSize).CopyToAsync(fs);
            ConfigurationHelper.SetAppSetting("CustomLogoPath", "images/" + e.File.Name ?? "");
            customlogopath = "images/" + e.File.Name;
            message.Message = "Custom Logo uploaded!";
        }
        catch (Exception ex)
        {
            await AdminLogService!.PostItemAsync(new AdminLogMessage() { Title = "ERROR", Message = ex.Message });
            message.Message = "There was a problem uploading the custom logo!";
            message.Header = "ERROR";
        }
        workingmodal.Close();
        if (GeneralHelper.IsNotNull(message.Message))
        {
            switch (message.Type)
            {
                case MessageTypesEnum.INFORMATION:
                    toastService.ShowInfo(message.Message);
                    break;
                case MessageTypesEnum.SUCCESS:
                    toastService.ShowSuccess(message.Message);
                    break;
                case MessageTypesEnum.WARNING:
                    toastService.ShowWarning(message.Message);
                    break;
                case MessageTypesEnum.ERROR:
                    toastService.ShowError(message.Message);
                    break;
            }
            await AdminLogService!.PostItemAsync(new AdminLogMessage() { Title = message.Type.ToString(), Message = message.Message, Source = currentuser });
        }
        StateHasChanged();
    }
}


