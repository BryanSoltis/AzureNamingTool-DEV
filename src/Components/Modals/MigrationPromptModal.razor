@using AzureNamingTool.Helpers
@using AzureNamingTool.Models
@using AzureNamingTool.Services
@inject StateContainer state
@inject IToastService toastService
@inject ILogger<MigrationPromptModal> Logger
@inject IStorageMigrationService MigrationService

<div class="modal fade show" id="migrationModal" style="display:block; background-color: rgba(10,10,10,.8);"
     aria-modal="true" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content @state.AppTheme">
            <div class="modal-header bg-primary text-white">
                <h3><i class="bi bi-database-gear"></i> Upgrade to SQLite Storage</h3>
            </div>
            <div class="modal-body">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">New Storage Option Available!</h5>
                        <p class="mb-3">
                            A new SQLite storage provider is now available, offering improved performance and reliability.
                        </p>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6><i class="bi bi-file-earmark-text"></i> Current: JSON Files</h6>
                                <ul class="small">
                                    <li>Simple file-based storage</li>
                                    <li>Works well for single-user scenarios</li>
                                    <li>May have concurrency limitations</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="bi bi-database"></i> New: SQLite Database</h6>
                                <ul class="small text-success">
                                    <li>✓ Better performance for large datasets</li>
                                    <li>✓ Improved multi-user concurrency</li>
                                    <li>✓ ACID transactions (data integrity)</li>
                                    <li>✓ Still embedded (no external server)</li>
                                </ul>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Safe Migration:</strong> Your JSON files will be backed up before migration.
                            You can rollback if needed from the Admin page.
                        </div>

                        @if (showMigrationStatus)
                        {
                            <div class="alert alert-warning">
                                <i class="bi bi-hourglass-split"></i>
                                <strong>Migration in progress...</strong>
                                <div class="progress mt-2">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                                </div>
                            </div>
                        }

                        @if (!String.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>Error:</strong> @errorMessage
                            </div>
                        }
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" @onclick="MigrateNow" disabled="@isProcessing">
                    <i class="bi bi-arrow-right-circle"></i> Migrate Now
                </button>
                <button type="button" class="btn btn-secondary" @onclick="KeepJSON" disabled="@isProcessing">
                    <i class="bi bi-file-earmark-text"></i> Keep Using JSON
                </button>
                <button type="button" class="btn btn-outline-secondary" @onclick="RemindLater" disabled="@isProcessing">
                    <i class="bi bi-clock"></i> Remind Me Later
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public EventCallback<MigrationChoice> OnClose { get; set; }

    private bool isProcessing = false;
    private bool showMigrationStatus = false;
    private string errorMessage = string.Empty;

    private async Task MigrateNow()
    {
        try
        {
            isProcessing = true;
            showMigrationStatus = true;
            errorMessage = string.Empty;
            StateHasChanged();

            // Perform the migration
            var result = await MigrationService.MigrateToSQLiteAsync();

            if (result.Success)
            {
                // Update configuration to use SQLite
                var config = ConfigurationHelper.GetConfigurationData();
                config.StorageProvider = "SQLite";
                await ConfigurationHelper.UpdateSettings(config);

                toastService.ShowSuccess("Migration completed successfully! Please restart the application.");
                await OnClose.InvokeAsync(MigrationChoice.Migrated);
            }
            else
            {
                errorMessage = $"Migration failed: {result.Message}";
                Logger.LogError("Migration failed: {Message}. Errors: {Errors}", result.Message, string.Join(", ", result.Errors));
                isProcessing = false;
                showMigrationStatus = false;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Unexpected error during migration: {ex.Message}";
            Logger.LogError(ex, "Unexpected error during migration");
            isProcessing = false;
            showMigrationStatus = false;
            StateHasChanged();
        }
    }

    private async Task KeepJSON()
    {
        // User wants to keep using JSON - update configuration
        var config = ConfigurationHelper.GetConfigurationData();
        config.MigrationPromptDismissed = "True";
        config.StorageProvider = "FileSystem";
        await ConfigurationHelper.UpdateSettings(config);

        toastService.ShowInfo("Continuing with JSON file storage.");
        await OnClose.InvokeAsync(MigrationChoice.KeepJSON);
    }

    private async Task RemindLater()
    {
        // Don't update MigrationPromptDismissed - user will see prompt again next time
        toastService.ShowInfo("You can migrate from the Admin page anytime.");
        await OnClose.InvokeAsync(MigrationChoice.RemindLater);
    }

    public enum MigrationChoice
    {
        Migrated,
        KeepJSON,
        RemindLater
    }
}
